!function(e){function t(s){if(r[s])return r[s].exports;var o=r[s]={i:s,l:!1,exports:{}};return e[s].call(o.exports,o,o.exports,t),o.l=!0,o.exports}var r={};t.m=e,t.c=r,t.d=function(e,r,s){t.o(e,r)||Object.defineProperty(e,r,{configurable:!1,enumerable:!0,get:s})},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},t.p="",t(t.s=7)}([function(e,t){e.exports=require("debug")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("mongoose")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(10);t.mongoURL=s.mongoURL;var o=r(11);t.ip=o.ip,t.port=o.port;var n=r(12);t.secret=n.secret;var a=r(13);t.image=a.image},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(17);t.UserModel=s.UserModel;var o=r(20);t.ArticleModel=o.ArticleModel},function(e,t){e.exports=require("passport")},function(e,t){e.exports=require("mongoose-unique-validator")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(1),o=r(8),n=r(9),a=r(2),i=r(0),u=r(3),d=r(14),l=i("paraboloid:server");l(">>> express");var c=s();l(">>> bodyParser"),c.use(o.json()),c.use(o.urlencoded({extended:!1})),l(">>> mongoose"),a.Promise=global.Promise,a.connect(u.mongoURL,{useMongoClient:!0}),l(">>> extra logging"),"development"===c.get("env")&&(c.use(n("dev")),a.set("debug",!0)),l(">>> api routes"),c.use(d.api),l(">>> dummy route"),c.use(function(e,t,r){t.status(404).send("Not Found")}),l(">>> error handler"),c.use(function(e,t,r,s){l("Error %o (%o): %o",r.statusCode,e.name,e.message),r.status(r.statusCode||500).send(e.message)}),l(">>> listener");var p=c.listen(u.port,u.ip,function(){console.log("Listening on "+p.address().address+":"+p.address().port)})},function(e,t){e.exports=require("body-parser")},function(e,t){e.exports=require("morgan")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(0),o=s("paraboloid:server:config:mongo"),n=process.env.OPENSHIFT_MONGODB_DB_URL||process.env.MONGO_URL||"mongodb://localhost/paraboloid";if(t.mongoURL=n,o("original mongoURL %o",n),void 0===n&&process.env.DATABASE_SERVICE_NAME){var a=process.env.DATABASE_SERVICE_NAME;a&&a.toUpperCase();var i=process.env[a+"_SERVICE_HOST"],u=process.env[a+"_SERVICE_PORT"],d=process.env[a+"_DATABASE"],l=process.env[a+"_USER"],c=process.env[a+"_PASSWORD"];i&&u&&d&&(t.mongoURL=n="mongodb://",l&&c&&(t.mongoURL=n+=l+":"+c+"@"),t.mongoURL=n+=i+":"+u+"/"+d)}o("new mongoURL %o",n)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(0),o=s("paraboloid:server:config:address");t.ip=process.env.IP||process.env.OPENSHIFT_NODEJS_IP||"0.0.0.0",o("ip %o",t.ip),t.port=parseInt(process.env.PORT||process.env.OPENSHIFT_NODEJS_PORT||"8080"),o("port %o",t.port)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(0),o=s("paraboloid:server:config:secret");t.secret=process.env.SECRET||"secret",o("secret %o",t.secret)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.image="https://static.productionready.io/images/smiley-cyrus.jpg"},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(15);t.api=s.api,s.api.use("/api",s.api)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(1),o=r(5),n=r(16),a=r(24),i=r(25),u=r(26),d=r(27);o.use(d.strategy);var l=s.Router();t.api=l,l.use("/users",n.users),l.use("/articles",a.articles),l.use("/tags",i.tags),l.use(u.errors)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(1),o=r(5),n=r(0),a=r(4),i=r(22),u=n("paraboloid:server:API:users"),d=s.Router();t.users=d;var l=new i.Authorization;d.post("/",function(e,t,r){u(">>> post /api/users/ with body %o",e.body);var s=new a.UserModel;e.body.user&&(s.username=e.body.user.username,s.email=e.body.user.email,s.bio=e.body.user.bio,s.image=e.body.user.image,s.setPassword(e.body.user.password)),s.save().then(function(){return u("user %o successfully saved",s.username),t.status(201).json({user:s.getAuthJSON()})}).catch(r)}),d.post("/login",function(e,t,r){u(">>> post /api/users/login with body %o",e.body);var s=e.body.user;return s?s.email?s.password?void o.authenticate("local",{session:!1},function(e,s,o){return e?(u("Error occured: %o",e),r(e)):s?(u("User found: %o",s),t.json({user:s.getAuthJSON()})):(u("Information: %o",o),t.status(422).json({errors:o}))})(e,t,r):(u("No password for user %o found",s.username),t.status(422).json({errors:{password:"can't be blank"}})):(u("No email for user %o found",s.username),t.status(422).json({errors:{email:"can't be blank"}})):(u("No user found"),t.status(422).json({errors:{user:"not found"}}))}),d.put("/user",l.required,function(e,t,r){u(">>> put /api/users/user with body %o/payload %o",e.body,e.payload),a.UserModel.findById(e.payload.id).then(function(s){var o=e.body.user;s?(u("User %o will be updated",s.username),o&&(o.username&&(s.username=o.username),o.email&&(s.email=o.email),o.bio&&(s.bio=o.bio),o.image&&(s.image=o.image),o.password&&s.setPassword(o.password.substr(100))),s.save().then(function(){return u("User %o was updated",s.username),t.status(200).json({user:s.getAuthJSON()})}).catch(r)):(u("User not valid"),t.status(401).send({errors:{user:"not valid"}}))}).catch(r)}),d.get("/user",l.required,function(e,t,r){u(">>> get /api/users/user with payload %o",e.payload),a.UserModel.findById(e.payload.id).then(function(e){if(e)return u("User %o was read",e.username),t.status(200).json({user:e.getAuthJSON()});u("User not valid"),t.status(401).send({errors:{user:"not valid"}})}).catch(r)}),d.delete("/user",l.required,function(e,t,r){u(">>> delete /api/users/user with payload %o",e.payload),a.UserModel.findById(e.payload.id).then(function(e){e?(u("User %o will be deleted",e.username),e.remove().then(function(){return u("User %o was deleted",e.username),t.sendStatus(204)}).catch(r)):(u("User not valid"),t.status(401).send({errors:{user:"not valid"}}))}).catch(r)})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(6),o=r(18),n=r(19),a=r(0),i=r(3),u=r(2),d=a("paraboloid:server:models:user"),l=new u.Schema({username:{type:String,lowercase:!0,unique:!0,required:[!0,"can't be blank"],match:[/^[a-zA-Z0-9]+$/,"is invalid"],index:!0,maxlength:30},email:{type:String,lowercase:!0,unique:!0,required:[!0,"can't be blank"],match:[/\S+@\S+\.\S+/,"is invalid"],index:!0,maxlength:50},bio:{type:String,maxlength:1e4},image:{type:String,maxlength:200,match:[/\S+\.\S+/,"is invalid"]},hash:{type:String,required:[!0,"can't be blank"]},salt:{type:String,required:[!0,"can't be blank"]}},{timestamps:!0});l.plugin(s,{message:"is already taken."}),l.methods.validPassword=function(e){if(d("Password %o is checked",e),e){var t=o.pbkdf2Sync(e,this.salt,1e4,512,"sha512").toString("hex");return d("Comparision of user and password hashes succeeded: %o",t===this.hash),this.hash===t}return!1},l.methods.setPassword=function(e){d("password %o",e),e&&(this.salt=o.randomBytes(16).toString("hex"),this.hash=o.pbkdf2Sync(e,this.salt,1e4,512,"sha512").toString("hex"),d("hash %o and salt %o generated",this.hash,this.salt))},l.methods.generateJWT=function(){var e=new Date,t=new Date(e);return t.setDate(e.getDate()+60),d("JWT generated for %o until %o",this.username,t),n.sign({id:this._id,username:this.username,exp:t.getTime()/1e3},i.secret)},l.methods.getAuthJSON=function(){var e={username:this.username,email:this.email,token:this.generateJWT(),bio:this.bio,image:this.image};return d("JWT token: %o",e),e},l.methods.getProfileJSON=function(){var e={username:this.username,email:this.email,bio:this.bio,image:this.image||i.image};return d("User profile: %o",e),e},t.UserModel=u.model("User",l)},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(6),o=r(21),n=r(0),a=r(2),i=(n("paraboloid:server:models:article"),new a.Schema({slug:{type:String,lowercase:!0,unique:!0,maxlength:100},title:{type:String,maxlength:100},description:{type:String,maxlength:1e3},body:{type:String,maxlength:1e5},tagList:[{type:String,maxlength:100}],author:{type:a.Schema.Types.ObjectId,ref:"User"},comments:[{type:a.Schema.Types.ObjectId,ref:"Comment"}]},{timestamps:!0}));t.ArticleSchema=i,i.plugin(s,{message:"is already taken."}),i.pre("validate",function(e){this.slug||this.slugify(),e()}),i.methods.slugify=function(){this.slug=o(this.title)+"-"+(Math.random()*Math.pow(36,6)|0).toString(36)},i.methods.getArticleJSON=function(){return{slug:this.slug,title:this.title,description:this.description,body:this.body,tagList:this.tagList,author:this.author.getProfileJSON(),createdAt:this.createdAt,updatedAt:this.updatedAt}},t.ArticleModel=a.model("Article",i)},function(e,t){e.exports=require("slug")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(23),o=r(0),n=r(3),a=o("paraboloid:server:API:auth"),i=function(){function e(){}return e.prototype.getTokenFromHeader=function(e){if(a("authorization header: %o",e.headers.authorization),e.headers.authorization){var t=e.headers.authorization.toString();if("Token"===t.split(" ")[0]||"Bearer"===t.split(" ")[0])return t.split(" ")[1]}return null},Object.defineProperty(e.prototype,"required",{get:function(){return s({secret:n.secret,userProperty:"payload",getToken:this.getTokenFromHeader})},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"optional",{get:function(){return s({secret:n.secret,userProperty:"payload",credentialsRequired:!1,getToken:this.getTokenFromHeader})},enumerable:!0,configurable:!0}),e}();t.Authorization=i},function(e,t){e.exports=require("express-jwt")},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(1),o=s.Router();t.articles=o,o.get("/",function(e,t){t.status(200),t.json({path:e.originalUrl,tag:e.query.tag,author:e.query.author,limit:e.query.limit,offset:e.query.offset})}),o.post("/",function(e,t){t.status(201),t.json({path:e.originalUrl})}),o.get("/:slug",function(e,t){t.status(200),t.json({path:e.originalUrl,slug:e.params.slug})}),o.put("/:slug",function(e,t){t.status(200),t.json({path:e.originalUrl,slug:e.params.slug})}),o.delete("/:slug",function(e,t){t.status(200),t.json({path:e.originalUrl,slug:e.params.slug})}),o.post("/:slug/comments",function(e,t){t.status(201),t.json({path:e.originalUrl,slug:e.params.slug})}),o.get("/:slug/comments",function(e,t){t.status(200),t.json({path:e.originalUrl,slug:e.params.slug})}),o.delete("/:slug/comments/:id",function(e,t){t.status(200),t.json({path:e.originalUrl,slug:e.params.slug,id:e.params.id})})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(1),o=r(4),n=s.Router();t.tags=n,n.get("/",function(e,t,r){o.ArticleModel.find().distinct("tagList").then(function(e){return t.json({tags:e})}).catch(r)})},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(0),o=s("paraboloid:server:API:errors");t.errors=function(e,t,r,s){if("ValidationError"===e.name)return o("%o: %o",e.name,e.message),r.status(422).json({errors:Object.keys(e.errors).reduce(function(t,r){return t[r]=e.errors[r].message,t},{})});(e.name="UnauthorizedError")?r.status(401).send({errors:{authorization:"failed"}}):s(e)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var s=r(0),o=r(28),n=r(4),a=s("paraboloid:server:API:strategy");t.strategy=new o.Strategy({usernameField:"user[email]",passwordField:"user[password]"},function(e,t,r){a("Login with email %o and password %o",e,t),n.UserModel.findOne({email:e.toLowerCase()}).then(function(e){return e&&e.validPassword(t)?(a("Valid credentials for user %o found",e.username),r(null,e)):(a("Credentials are not valid"),r(null,!1,{message:"email or password is invalid"}))}).catch(r)})},function(e,t){e.exports=require("passport-local")}]);